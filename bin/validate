#!/usr/bin/env bash
# Validate dotfiles installation and configuration

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "Validating dotfiles installation..."
echo "===================================="
echo ""

errors=0
warnings=0

# Check 1: Dotbot submodule exists
if [[ -f "$DOTFILES_DIR/dotbot/bin/dotbot" ]]; then
    echo "✓ Dotbot submodule initialized"
else
    echo "✗ Dotbot submodule not initialized"
    echo "  Run: just init"
    errors=$((errors + 1))
fi

# Check 2: Install script exists and is executable
if [[ -x "$DOTFILES_DIR/install" ]]; then
    echo "✓ Install script is executable"
else
    echo "✗ Install script missing or not executable"
    errors=$((errors + 1))
fi

# Check 3: Required config files exist
required_configs=(
    "install-base.conf.yaml"
    "install-home.conf.yaml"
    "install-work.conf.yaml"
    "install-claude.conf.yaml"
    "install-rad.conf.yaml"
)

for config in "${required_configs[@]}"; do
    if [[ -f "$DOTFILES_DIR/$config" ]]; then
        echo "✓ $config exists"
    else
        echo "✗ $config missing"
        errors=$((errors + 1))
    fi
done

# Check 4: Key symlinks are present (if installation has been run)
if [[ -L ~/.zshrc ]]; then
    zshrc_target=$(readlink ~/.zshrc)
    if [[ -f "$zshrc_target" ]]; then
        echo "✓ ~/.zshrc symlink is valid"
        if echo "$zshrc_target" | grep -q "zshrc.home"; then
            echo "  → Points to home profile"
        elif echo "$zshrc_target" | grep -q "zshrc.work"; then
            echo "  → Points to work profile"
        fi
    else
        echo "⚠ ~/.zshrc symlink is broken"
        warnings=$((warnings + 1))
    fi
else
    echo "⚠ ~/.zshrc is not a symlink (installation may not have been run)"
    warnings=$((warnings + 1))
fi

# Check 5: Config directory exists
if [[ -d "$DOTFILES_DIR/config" ]]; then
    echo "✓ config directory exists"

    # Check for key config files
    key_files=(
        "aider.conf.global.yml"
        "zshrc.home"
        "zshrc.work"
        "p10k.global.zsh"
    )

    for file in "${key_files[@]}"; do
        if [[ -f "$DOTFILES_DIR/config/$file" ]]; then
            echo "  ✓ config/$file exists"
        else
            echo "  ✗ config/$file missing"
            errors=$((errors + 1))
        fi
    done
else
    echo "✗ config directory missing"
    errors=$((errors + 1))
fi

# Check 6: tmux config directory symlink
if [[ -L ~/.config/tmux ]]; then
    tmux_target=$(readlink ~/.config/tmux)
    if [[ -d "$tmux_target" ]]; then
        echo "✓ ~/.config/tmux symlink is valid"
    else
        echo "⚠ ~/.config/tmux symlink is broken"
        warnings=$((warnings + 1))
    fi
else
    echo "⚠ ~/.config/tmux is not a symlink (may not be installed yet)"
    warnings=$((warnings + 1))
fi

# Check 7: Claude Code configuration
if [[ -L ~/.claude/CLAUDE.md ]]; then
    echo "✓ Claude Code configuration symlinked"
else
    echo "⚠ Claude Code configuration not symlinked"
    warnings=$((warnings + 1))
fi

echo ""
echo "===================================="
echo "Summary: $errors errors, $warnings warnings"

if [[ $errors -gt 0 ]]; then
    echo "❌ Validation failed - please fix errors above"
    exit 1
elif [[ $warnings -gt 0 ]]; then
    echo "⚠️  Validation passed with warnings"
    echo "   (Run 'just install home' or 'just install work' to complete setup)"
    exit 0
else
    echo "✅ All checks passed!"
    exit 0
fi
