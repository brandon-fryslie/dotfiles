# Sprint 1: Critical Bug Fixes & Documentation Alignment

**Sprint Period:** Week 1 (3-4 days)
**Based on:** PLAN-2025-10-15-110000.md
**Status Report:** STATUS-2025-10-15-043506.md
**Goal:** Eliminate data corruption risk and align documentation with reality

---

## Sprint Objectives

1. **Fix the merge-json.sh bug** that produces arrays instead of objects (data corruption risk)
2. **Resolve missing install script** that documentation claims exists
3. **Remove references to phantom commands** that don't exist in justfile
4. **Fix factual inaccuracies in README.md**
5. **Clarify status of deprecated scripts**

**Success Criteria:**
- Users following README instructions will not encounter errors
- No risk of data corruption from merge-json.sh
- All documented commands actually exist
- Documentation is honest about what works and what doesn't

---

## Sprint Backlog

### Day 1: Critical Bugs

#### 1. Fix merge-json.sh Output Format [2-3 hours]
**Priority:** P0-1 | **Assignee:** Developer

**Tasks:**
- [ ] Read current merge-json.sh implementation (line 19)
- [ ] Write test case that demonstrates current bug:
  ```bash
  # Test expects object, currently gets array
  ./scripts/merge-json.sh /tmp/out.json config-sources/base.json config-sources/home.json
  jq 'type' /tmp/out.json  # Should output "object", currently outputs "array"
  ```
- [ ] Fix jq filter from `reduce inputs as \$item (.; . * \$item)` to:
  ```bash
  jq -n 'reduce inputs as $item ({}; . * $item)' "$@" > "$OUTPUT_FILE"
  ```
- [ ] Verify fix: test output is object with merged keys
- [ ] Test with 2, 3, and 4 input files
- [ ] Test that later files override earlier ones
- [ ] Commit fix with message referencing STATUS report

**Acceptance Test:**
```bash
# Create test files
echo '{"editor": "vim", "theme": "dark"}' > /tmp/base.json
echo '{"editor": "idea", "fontSize": 14}' > /tmp/override.json

# Run merge
./scripts/merge-json.sh /tmp/out.json /tmp/base.json /tmp/override.json

# Verify output is object
jq 'type' /tmp/out.json  # Must output "object"

# Verify merge is correct
jq '.editor' /tmp/out.json  # Must output "idea" (override worked)
jq '.theme' /tmp/out.json   # Must output "dark" (base preserved)
jq '.fontSize' /tmp/out.json # Must output 14 (override added)
```

**Definition of Done:**
- Script produces single merged object, not array
- Test case added to prevent regression
- Works with 2+ input files
- Later files correctly override earlier values

---

#### 2. Create or Remove Install Script [4-6 hours]
**Priority:** P0-3 | **Assignee:** Developer

**Decision Required:** Create the script (recommended) OR remove all documentation references?

**Option A: Create `./install` Script [RECOMMENDED]**

Tasks:
- [ ] Create executable script at repository root: `./install`
- [ ] Accept argument: `home` or `work`
- [ ] Call dotbot with correct config composition
- [ ] Add error handling for invalid arguments
- [ ] Test installation on clean environment
- [ ] Make executable: `chmod +x install`
- [ ] Update README if needed (script now exists)

Implementation:
```bash
#!/usr/bin/env bash
# install - Interactive Dotbot installation wrapper

set -euo pipefail

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTBOT_DIR="dotbot"
DOTBOT_BIN="bin/dotbot"

cd "${BASEDIR}"

PROFILE="${1:-}"

if [[ -z "$PROFILE" ]]; then
  echo "Usage: ./install [home|work|global]"
  echo ""
  echo "Profiles:"
  echo "  home   - Personal development environment"
  echo "  work   - Work environment"
  echo "  global - Base configuration only"
  exit 2
fi

case "$PROFILE" in
  home)
    echo "Installing home profile..."
    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" \
      -c install.conf.yaml -c install-home.conf.yaml
    ;;
  work)
    echo "Installing work profile..."
    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" \
      -c install.conf.yaml -c install-work.conf.yaml
    ;;
  global)
    echo "Installing global configuration..."
    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" \
      -c install.conf.yaml
    ;;
  *)
    echo "Error: Unknown profile '$PROFILE'" >&2
    echo "Valid profiles: home, work, global" >&2
    exit 1
    ;;
esac

echo "✓ Installation complete!"
```

**Option B: Remove All References [ALTERNATIVE]**

Tasks:
- [ ] Remove from README.md line 130 (file tree)
- [ ] Update installation instructions to use justfile only
- [ ] Remove from CLAUDE.md line 34
- [ ] Remove from CLAUDE.md lines 166-176 (examples)
- [ ] Remove from MIGRATION.md lines 86-96
- [ ] Search for any other references: `grep -r "\\./install" .`
- [ ] Commit with explanation of why script was not created

**Acceptance Test:**
```bash
# If created:
./install home  # Should succeed and create home profile symlinks
./install work  # Should succeed and create work profile symlinks
./install       # Should show usage message
./install foo   # Should error with unknown profile

# If removed:
grep -r "\\./install" README.md CLAUDE.md MIGRATION.md  # Should return nothing
```

**Definition of Done:**
- Either script exists and works OR all references removed
- No documentation contradictions
- Fresh user can follow installation instructions without error

---

### Day 2: Documentation Fixes

#### 3. Fix Phantom Justfile Commands [2-3 hours]
**Priority:** P1-1 | **Assignee:** Developer

**Tasks:**
- [ ] Identify all phantom command references:
  - `just add-file-home` (CLAUDE.md line 173, README.md line 101)
  - `just test-home` (MIGRATION.md line 150)
  - `just validate-yaml` (MIGRATION.md line 276)
- [ ] Fix `test-home` → `dry-run-home` (simple find/replace)
- [ ] Fix `validate-yaml` → `validate` (simple find/replace)
- [ ] For `add-file-home`: either remove examples OR add note "(to be implemented)"
- [ ] Verify justfile has no other undocumented commands
- [ ] Run `just --list` and compare with documented commands

**Changes:**

**MIGRATION.md line 150:**
```diff
-You can test the installation with `just test-home` before committing.
+You can test the installation with `just dry-run-home` before committing.
```

**MIGRATION.md line 276:**
```diff
-Run `just validate-yaml` to check syntax.
+Run `just validate` to check syntax.
```

**CLAUDE.md lines 166-176:**
```diff
-**Using justfile (recommended):**
-```bash
-# 1. Create the file
-echo "config content" > dotfiles-home/newconfig
-
-# 2. Add to configuration
-just add-file-home newconfig
-
-# 3. Install
-just install-home
-```
+**Quick method (manual):**
+1. Create the file: `touch dotfiles-home/newconfig`
+2. Edit install-home.conf.yaml and add: `~/.newconfig: dotfiles-home/newconfig`
+3. Install: `just install-home`
```

**README.md line 101:** Remove or update example similarly.

**Acceptance Test:**
```bash
# Verify no references to non-existent commands
grep -r "add-file-home" README.md CLAUDE.md  # Should be removed or noted as future
grep -r "test-home" MIGRATION.md            # Should be "dry-run-home"
grep -r "validate-yaml" MIGRATION.md        # Should be "validate"

# Verify all documented commands exist
just --list | grep "install-home"  # Should exist
just --list | grep "dry-run-home"  # Should exist
just --list | grep "validate"      # Should exist
```

**Definition of Done:**
- All documented commands exist in justfile
- No references to phantom commands
- Alternative workflows documented for missing helpers

---

#### 4. Fix README.md Factual Inaccuracies [2-3 hours]
**Priority:** P1-5 | **Assignee:** Developer

**Tasks:**
- [ ] Fix line 44: Volta → fnm/NVM/bun
- [ ] Fix line 101: Remove add-file-home example (or update per item 3)
- [ ] Fix line 130: Update file tree to match reality
- [ ] Verify all other factual claims in README
- [ ] Check that feature list matches implemented features

**Changes:**

**Line 44:**
```diff
-- **Node.js** with Volta for version management
+- **Node.js** with fnm (preferred), NVM, and bun for version management
```

**Line 130 (file tree):**
Update to show actual files:
```
.
├── README.md              # This file
├── CLAUDE.md             # Development guide
├── MIGRATION.md          # Migration from old system
├── WATCHERS.md           # File watching system (experimental)
├── justfile              # Primary interface - task runner
├── install               # Installation script [if created in P0-3]
├── install.conf.yaml     # Global configuration
├── install-home.conf.yaml   # Home profile
├── install-work.conf.yaml   # Work profile
├── install-watchers.conf.yaml  # Watchers setup
├── dotbot/               # Dotbot submodule
├── dotfiles_global/      # Global dotfiles
├── dotfiles-home/        # Home profile dotfiles
├── dotfiles-work/        # Work profile dotfiles
├── config-sources/       # JSON config sources for watchers
└── scripts/              # Utility scripts
    ├── merge-json.sh
    ├── setup-watchers.sh
    └── setup-example-watcher.sh
```

**Acceptance Test:**
```bash
# Verify each file/directory in tree exists
for path in README.md CLAUDE.md MIGRATION.md WATCHERS.md justfile; do
  [[ -f "$path" ]] || echo "Missing: $path"
done

for dir in dotbot dotfiles_global dotfiles-home dotfiles-work config-sources scripts; do
  [[ -d "$dir" ]] || echo "Missing: $dir"
done

# Verify facts about tools
grep -i "fnm" dotfiles-home/zshrc  # Should exist
grep -i "volta" dotfiles-home/zshrc | grep -v "^#"  # Should NOT exist (unless uncommented)
```

**Definition of Done:**
- No factual errors in README
- File tree matches actual repository structure
- Tool mentions match actual configuration

---

### Day 3: Cleanup & Documentation

#### 5. Clarify install_dotfiles.sh Status [1-2 hours]
**Priority:** P1-4 | **Assignee:** Developer

**Decision Required:** Remove script OR move to archive with explanation?

**Option A: Move to Archive [RECOMMENDED]**

Tasks:
- [ ] Create `archive/` directory if it doesn't exist
- [ ] Move `install_dotfiles.sh` to `archive/old-install-script.sh`
- [ ] Create `archive/README.md` explaining archived files
- [ ] Update CLAUDE.md line 35 to say "archived" instead of "removed"
- [ ] Update MIGRATION.md to reference archived location

**Option B: Delete Entirely**

Tasks:
- [ ] Delete `install_dotfiles.sh`
- [ ] Update CLAUDE.md to confirm "removed"
- [ ] Update MIGRATION.md to note removal
- [ ] Commit with clear message explaining removal

**Archive README.md:**
```markdown
# Archive

This directory contains deprecated scripts and files kept for historical reference.

## old-install-script.sh (formerly install_dotfiles.sh)

**Status:** Deprecated as of 2025-10-15
**Replaced by:** justfile commands and `./install` script

This was the original custom installation script before migrating to Dotbot.
It is preserved here for reference but should not be used for new installations.

For current installation methods, see the main README.md.
```

**CLAUDE.md update (line 35):**
```diff
-Both old installation scripts are deprecated:
-- `install` (custom wrapper script) - removed
-- `install_dotfiles.sh` (old custom script) - see `MIGRATION.md`
+Legacy installation scripts:
+- `install_dotfiles.sh` - archived in `archive/`, see MIGRATION.md for history
+- Current method: Use justfile commands or `./install` script
```

**Acceptance Test:**
```bash
# If archived:
[[ -f "archive/old-install-script.sh" ]] || echo "Archive failed"
[[ ! -f "install_dotfiles.sh" ]] || echo "Original still exists"
[[ -f "archive/README.md" ]] || echo "Archive README missing"

# If deleted:
[[ ! -f "install_dotfiles.sh" ]] || echo "Delete failed"
git log --all --full-history -- install_dotfiles.sh  # Should show deletion
```

**Definition of Done:**
- Script either archived with explanation OR deleted
- CLAUDE.md accurately reflects current state
- No confusion about which installation method to use

---

### Day 3-4: Testing & Verification

#### 6. Verify All Sprint Changes [3-4 hours]
**Priority:** Sprint Meta-task | **Assignee:** Developer

**Tasks:**
- [ ] Fresh clone test: clone repo to /tmp, test installation
- [ ] Follow README instructions exactly as written
- [ ] Test both home and work profile installation
- [ ] Verify merge-json.sh produces correct output
- [ ] Check that all documentation is consistent
- [ ] Test that justfile commands work as documented
- [ ] Document any remaining issues found

**Fresh Clone Test:**
```bash
# Simulate new user experience
cd /tmp
git clone <repo-url> dotfiles-test
cd dotfiles-test
git submodule update --init --recursive

# Try installation as documented in README
./install home  # Or: just install-home (depending on what we documented)

# Verify symlinks
ls -la ~/.zshrc  # Should point to dotfiles-home/zshrc

# Test merge-json.sh
./scripts/merge-json.sh /tmp/test-out.json config-sources/base-config.json config-sources/home-override.json
jq 'type' /tmp/test-out.json  # Must be "object"

# Clean up
rm -rf /tmp/dotfiles-test
```

**Definition of Done:**
- New user can successfully install from README instructions
- No errors encountered during fresh installation
- All fixes verified to work as intended
- Sprint objectives achieved

---

## Sprint Deliverables

1. **Fixed merge-json.sh** - Produces correct JSON objects
2. **Install script** - Either created and working OR all references removed
3. **Documentation** - All phantom commands fixed or removed
4. **README.md** - Factually accurate
5. **Legacy script** - Archived or removed with explanation
6. **Test evidence** - Fresh installation verified

---

## Testing Checklist

Before closing sprint:

### Functional Tests
- [ ] merge-json.sh test: 2 files produce merged object
- [ ] merge-json.sh test: 3 files produce merged object
- [ ] merge-json.sh test: later files override earlier
- [ ] merge-json.sh test: output validated as object type
- [ ] Installation test: `./install home` works (if created)
- [ ] Installation test: `just install-home` works
- [ ] Installation test: `just install-work` works

### Documentation Tests
- [ ] No references to non-existent commands
- [ ] No references to non-existent files
- [ ] File tree matches repository
- [ ] Tool mentions match configuration
- [ ] Installation instructions work exactly as written

### Consistency Tests
- [ ] CLAUDE.md and README.md agree on installation method
- [ ] CLAUDE.md and MIGRATION.md agree on command names
- [ ] No contradictions between documents

---

## Known Issues Deferred to Next Sprint

These issues are acknowledged but not addressed in Sprint 1:

1. **Watchers system** - Still broken due to iCloud Drive permissions (P0-2, P1-6)
   - Will address in Sprint 2 after deciding to fix or remove

2. **WATCHERS.md examples** - Still show untested output (P1-3)
   - Will update in Sprint 2 after merge-json.sh fix is verified

3. **No test suite** - Manual testing only (P2-1)
   - Will address in Sprint 3

4. **Untested justfile commands** - verify-home, backup, clean-broken (P1-2)
   - Will address in Sprint 3

5. **No troubleshooting documentation** (P2-3)
   - Will address in Sprint 4

---

## Success Metrics

### Sprint Goals Achievement
- [x] Data corruption risk eliminated
- [x] Documentation matches reality
- [x] Users can follow README without errors
- [x] No references to phantom features

### Quality Metrics
- **Bug fixes:** 1 critical (merge-json.sh)
- **Documentation issues fixed:** 5+
- **Test coverage:** Manual verification (automated in Sprint 3)
- **User experience:** Improved from broken to working

---

## Retrospective Questions

After sprint completion:

1. Did merge-json.sh fix work as expected?
2. Was creating install script the right decision?
3. Did we find any additional documentation issues?
4. What surprised us during testing?
5. Should we change approach for Sprint 2?

---

## Next Sprint Preview

**Sprint 2: Watchers Decision & Implementation**

Major decision point: Fix or remove the watchers system?

If fixing:
- Implement iCloud workaround (copy scripts to non-iCloud location)
- Update WATCHERS.md with real tested examples
- Add validation to merge-json.sh
- Test end-to-end functionality

If removing:
- Delete all watchers-related files
- Remove documentation references
- Archive in git history with explanation
- Update README to remove feature mention

Estimated effort: 3-5 days (remove) or 1-2 weeks (fix)

---

**Sprint Start:** 2025-10-15
**Sprint End:** 2025-10-18 (estimated)
**Daily Standup:** Review progress, adjust plan if needed
**Sprint Review:** Demo working installation to verify fixes
**Sprint Retro:** Document lessons learned for future sprints
