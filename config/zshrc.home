# Uncomment to enable profiling
# zmodload zsh/zprof

# Automatically deduplicate PATH entries
typeset -U path

setopt clobber
setopt share_history

# TODO: move this somewhere else, at minimum the helper fns
is_claude() { [[ -n "${CLAUDECODE}" ]] && return 0 || return 1 }
not_claude() { ! is_claude && return 0 || return 1 }

# We need to be able to define a set of plugins to load for human vs ai users
if is_claude; then
  # Use minimal plugin set for Claude Code (just essentials like history config)
  export RAD_PLUGINS_FILE=~/.rad-plugins.claude
  # Use separate zgenom cache for Claude to avoid clobbering human cache
  export ZGEN_INIT=~/.zgenom/sources/init-claude.zsh
else
  # Use full plugin set for human sessions
  export RAD_PLUGINS_FILE=~/.rad-plugins
  # Use default zgenom cache for human sessions
  export ZGEN_INIT=~/.zgenom/sources/init.zsh
fi

# Source rad-shell with appropriate plugin set
source ~/.rad-shell/rad-init.zsh

# Load p10k theme (skip for Claude since we don't need fancy prompts)
if not_claude; then
  [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
fi

# Add customizations below

# Theme configuration
export ENABLE_DOCKER_PROMPT=true
export LAZY_NODE_PROMPT=true

# Editor configuration
export VISUAL=idea
export EDITOR=vi

# Local code configuration
export PROJECTS_DIR="$HOME/icode"
PROJECTS_DIRS=(~/icode ~/projects)
export DOTFILES_DIR="$HOME/icode/dotfiles"

# Language configuration


# Ruby
#export PATH="$HOME/.rvm/bin:$PATH"

# Python
export PATH="/usr/local/opt/python/libexec/bin:$PATH"

# Github configuration
export GHE_USERNAME=brandon-fryslie

# ---

# Misc
alias e.="${VISUAL:-vi} ."
alias dog='pygmentize -g'
# Removed: git config --global core.excludesfile ~/.gitignore_global
# This should only be run once, not on every shell startup (causes file lock errors)
# Run manually if needed: git config --global core.excludesfile ~/.gitignore_global

# Move to a rad-shell plugin
# Try finding the first ethernet adapter that has a valid ipv4 address
local-ip() {
  for i in `seq 0 10`; do
    res="$(/sbin/ifconfig en${i} | grep 'inet' | grep -v inet6 | awk '{print $2}')"
    [[ -n $res ]] && echo $res && return
  done
}

AUTO_MENU=true
AUTO_LIST=true
#unsetopt listambiguous
setopt AUTO_MENU
setopt AUTO_LIST
setopt GLOB_COMPLETE
setopt COMPLETE_ALIASES
setopt AUTO_PARAM_SLASH

# TODO: move this to a plugin
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'

# TODO: move this to a plugin
JAVA_VERSION="temurin-11"
export JAVA_HOME="/Library/Java/JavaVirtualMachines/${JAVA_VERSION}.jdk/Contents/Home"
PATH="/Library/Java/JavaVirtualMachines/${JAVA_VERSION}.jdk/Contents/Home/bin/:${PATH}"

# what's this for?
PATH="$PATH:/opt/homebrew/opt/coreutils/libexec/gnubin:/usr/local/bin"

# TODO: plugin
export DOCKER_HOST="unix://$HOME/.lima/docker.sock"

# pyenv (lazy-loaded on first use)
export PYENV_ROOT="$HOME/.pyenv"
command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"

# Lazy-load pyenv to speed up shell startup
pyenv() {
  unfunction pyenv
  eval "$(command pyenv init -)"
  eval "$(command pyenv init --path)"
  which pyenv-virtualenv-init > /dev/null && eval "$(command pyenv virtualenv-init -)"
  pyenv "$@"
}

# Lazy-load python to trigger pyenv
python() {
  unfunction python
  eval "$(command pyenv init -)"
  eval "$(command pyenv init --path)"
  which pyenv-virtualenv-init > /dev/null && eval "$(command pyenv virtualenv-init -)"
  python "$@"
}

# SDKMAN (lazy-loaded on first use)
export SDKMAN_DIR="$HOME/.sdkman"

# Lazy-load SDKMAN on first use
sdk() {
  unfunction sdk
  [[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"
  sdk "$@"
}

# Crazy codesigning thing
#add-debug-entitlement() {
#  local executable_path=$1
#  rad-yellow "Adding debug entitlement to exec: ${executable_path}"
#  debug_plist=$(mktemp)
#  cat << EOF > $debug_plist
#<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "https://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>com.apple.security.get-task-allow</key><true/></dict></plist>
#EOF
#  rad-yellow "Wrote debug entitlement plist to ${debug_plist}.  Executing codesign..."
#  codesign -s - -v -f --entitlements ${debug_plist} ${executable_path}
#  rad-green "Done!"
#}
#

# pnpm
export PNPM_HOME="/Users/bmf/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PATH:$PNPM_HOME" ;;
esac
# pnpm end

alias n4j="/opt/homebrew/opt/neo4j/bin/neo4j console"
alias venv-direnv="echo 'source .venv/bin/activate' >> .envrc && direnv allow"

# Lazy-load fnm on first use
fnm() {
  unfunction fnm
  eval "$(command fnm env --use-on-cd --shell zsh)"
  fnm "$@"
}

# NVM removed - using fnm instead for faster Node.js version management
export PATH="/usr/local/opt/gnu-sed/libexec/gnubin:$PATH"
export PATH="$PATH:/Applications/IDA Professional 9.2.app/Contents/MacOS/dbgsrv"

# bun completions
[ -s "/Users/bmf/.bun/_bun" ] && source "/Users/bmf/.bun/_bun"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
export PATH="/Users/bmf/.swiftpm/bin:$PATH"

### Zinit plugin manager (optimized with turbo mode)
#if [[ ! -f $HOME/.local/share/zinit/zinit.git/zinit.zsh ]]; then
#    print -P "%F{33} %F{220}Installing %F{33}ZDHARMA-CONTINUUM%F{220} Initiative Plugin Manager (%F{33}zdharma-continuum/zinit%F{220})â€¦%f"
#    command mkdir -p "$HOME/.local/share/zinit" && command chmod g-rwX "$HOME/.local/share/zinit"
#    command git clone https://github.com/zdharma-continuum/zinit "$HOME/.local/share/zinit/zinit.git" && \
#        print -P "%F{33} %F{34}Installation successful.%f%b" || \
#        print -P "%F{160} The clone has failed.%f%b"
#fi
#
#source "$HOME/.local/share/zinit/zinit.git/zinit.zsh"
#autoload -Uz _zinit
#(( ${+_comps} )) && _comps[zinit]=_zinit

## Load annexes with turbo mode (asynchronous loading after prompt appears)
## This speeds up shell startup by deferring non-critical plugins
#zinit wait lucid light-mode for \
#    zdharma-continuum/zinit-annex-as-monitor \
#    zdharma-continuum/zinit-annex-bin-gem-node \
#    zdharma-continuum/zinit-annex-patch-dl \
#    zdharma-continuum/zinit-annex-rust

# Example: Load additional plugins with turbo
# zinit wait lucid for \
#     OMZP::git \
#     OMZP::sudo

### End of Zinit configuration
alias danger-claude="claude --dangerously-skip-permissions"

alias clod="claude --dangerously-skip-permissions"

alias wb_dl="docker run -v .:/websites wayback_machine_downloader wayback_machine_downloader"

# Lazy-load mcpi completions
mcpi() {
  unfunction mcpi
  type mcpi &>/dev/null && eval "$(_MCPI_COMPLETE=zsh_source command mcpi)"
  mcpi "$@"
}

export UV_PYTHON=3.12
export ABDUCO_CMD=zsh

# Final PATH deduplication (removes duplicates added by plugins/tools)
# This ensures PATH stays clean even when plugins add duplicate entries
typeset -U path
