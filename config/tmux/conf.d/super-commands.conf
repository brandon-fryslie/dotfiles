##### Vibe prefixless layer: Blink + iTerm2 #####
# Map these escape sequences in your terminal to Command+Option combos:
#
#   Cmd+Opt+M -> ESC ] 999 ; 0 BEL
#       Hex: 1b 5d 39 39 39 3b 30 07
#
#   Cmd+Opt+S -> ESC ] 999 ; 1 BEL
#       Hex: 1b 5d 39 39 39 3b 31 07
#
#   Cmd+Opt+J -> ESC ] 999 ; 2 BEL
#       Hex: 1b 5d 39 39 39 3b 32 07
#
#   Cmd+Opt+P -> ESC ] 999 ; 3 BEL
#       Hex: 1b 5d 39 39 39 3b 33 07
#
# In Blink/iTerm2, configure those keys to send literally:
#   ESC ] 999 ; N BEL      (where N = 0,1,2,3 as above)

set -s user-keys[0] "\e]999;0\007"   # Cmd+Opt+M
set -s user-keys[1] "\e]999;1\007"   # Cmd+Opt+S
set -s user-keys[2] "\e]999;2\007"   # Cmd+Opt+J
set -s user-keys[3] "\e]999;3\007"   # Cmd+Opt+P

##### 1. Toggle mouse mode (Cmd+Opt+M, User0) #####
# Flip mouse on/off globally and echo the state in the status line.
bind-key -n User0 if -F "#{mouse}" \
  "set -g mouse off \\; display-message 'mouse: off'" \
  "set -g mouse on  \\; display-message 'mouse: on'"

# Normal prefix + m shortcut to toggle mouse mode
bind-key m if -F "#{mouse}" \
  "set -g mouse off \\; display-message 'mouse: off'" \
  "set -g mouse on  \\; display-message 'mouse: on'"

##### 2. “Select session from list” (Cmd+Opt+S, User1) #####
# Same UI as the default Prefix + s, but prefixless.
bind-key -n User1 choose-tree -s

##### 3. Join neighbor window into current (Cmd+Opt+J, User2) #####
# Behavior:
#   - Uses the *next* window (:+) as the source.
#   - Only joins if:
#       • current window has at most 2 panes, AND
#       • the neighbor window has exactly 1 pane.
#   - This guarantees the resulting window will never exceed 3 panes.
#
# Notes:
#   - If the next window is multi-pane, we refuse and show a message.
#   - If the next window wraps around (you’re on the last index), tmux’s
#     standard :+ semantics apply (wrap to the first window).

bind-key -n User2 if-shell -F '#{&&:#{<=:#{window_panes},2}:#{==:#{window_panes:+},1}}' \
  'join-pane -s:+ -t:. \; display-message "joined window:+ into current"' \
  'display-message "join skipped (pane limit or multi-pane neighbor)"'

##### 4. Split current window into two windows (Cmd+Opt+P, User3) #####
# Behavior:
#   - If the current window has >1 pane, the *active* pane is broken out
#     into a new window (standard `break-pane` semantics).
#   - If there is only one pane, we skip and show a message.
#
# This matches the intuitive “take this pane and give it its own window”
# while keeping the operation very simple.

bind-key -n User3 if-shell -F '#{>:#{window_panes},1}' \
  'break-pane -d \; display-message "broke active pane into new window"' \
  'display-message "split skipped (only one pane)"'

##### 5. Window switching (Opt+Shift+[ and Opt+Shift+]) #####
# Navigate between windows like iTerm2 tabs
# With iTerm2 "Option sends Esc+", these keys send M-{ and M-}

bind-key -n 'M-{' previous-window
bind-key -n 'M-}' next-window

##### 6. Window management (Opt+Shift+N/X/S) #####
# With iTerm2 "Option sends Esc+", these send M-N, M-X, M-S

bind-key -n M-N new-window
bind-key -n M-X confirm-before -p "kill window #W? (y/n)" kill-window
bind-key -n M-s choose-tree -s

##### 7. Pane management (Opt+Shift+M/H/G, Opt+p, Opt+arrows) #####
# With iTerm2 "Option sends Esc+", these send M-M, M-H, M-G, M-p, M-arrows

bind-key -n M-M if -F "#{mouse}" \
  "set -g mouse off \; display-message 'mouse: off'" \
  "set -g mouse on  \; display-message 'mouse: on'"
bind-key -n M-H split-window -h
bind-key -n M-G split-window -v
bind-key -n M-K confirm-before -p "kill pane #P? (y/n)" kill-pane
bind-key -n M-L next-layout
bind-key -n M-p select-pane -t :.+

bind-key -n M-Left resize-pane -L 5
bind-key -n M-Right resize-pane -R 5
bind-key -n M-Up resize-pane -U 5
bind-key -n M-Down resize-pane -D 5

##### 8. Resize window to current client (Opt+r) #####
# When multiple clients are attached and window is constrained to smallest,
# this forces the window to resize to the current client's size

bind-key -n M-r resize-window -A \; display-message "window resized to current client"
