# Oscilla Animator v2 - Project Roadmap

Last updated: 2026-01-27-171000

---

## üü¢ Phase 1: Core Foundation [ACTIVE] (6/13 completed)

**Goal:** Implement the core compilation pipeline and runtime system according to the unified spec

**Status:** ACTIVE
**Started:** 2026-01-05
**Target Completion:** TBD
**Unified Plan:** `.agent_planning/phase1-remaining/PLAN-20260109-210000.md` (APPROVED)

### Topics

#### ‚úÖ update-blocks-types [COMPLETED]
- **State:** COMPLETED
- **Epic:** None
- **Description:** Refactor blocks to use centralized type helpers, split god blocks into composable primitives
- **Completed:** 2026-01-05
- **Summary:** PositionSwirl split into 5 composable blocks, HueRainbow split into 2. All tests pass.
- **Completion Report:** `.agent_planning/ARCHITECTURAL-REFACTOR-COMPLETE.md`

#### ‚úÖ canonical-arch-alignment [COMPLETED]
- **State:** COMPLETED
- **Epic:** None
- **Description:** Implement canonical 5-axis type system (PayloadType, AxisTag, Cardinality, Temporality, Binding, Extent, CanonicalType)
- **Completed:** 2026-01-09
- **Summary:** P0-P3 delivered. 68 tests passing. All 25 blocks migrated to CanonicalType system.
- **Planning Files:** `.agent_planning/canonical-arch-alignment/`

#### ‚úÖ design-docs-audit [COMPLETED]
- **State:** COMPLETED
- **Epic:** None
- **Description:** Audit design docs for contradictions, ambiguities, and inconsistencies
- **Planning Files:** `.agent_planning/design-docs-audit/`

#### ‚úÖ ir-5-axes [COMPLETED]
- **State:** COMPLETED
- **Epic:** Phase 1 Unified Plan (P0)
- **Spec:** `design-docs/IR-and-normalization-5-axes.md`
- **Description:** Implement 5-axis metadata in IR schema, CompiledProgramIR, slotMeta with offsets
- **Completed:** 2026-01-09
- **Summary:** CompiledProgramIR schema foundation complete. Dense execution tables, slot addressing with offsets, mandatory axes metadata, and DebugIndexIR all implemented. All 68 tests passing.
- **Planning Files:** `.agent_planning/ir-5-axes/`
- **Completion Report:** `.agent_planning/ir-5-axes/COMPLETION-20260109-212700.md`

#### ‚úÖ canonical-type [COMPLETED]
- **State:** COMPLETED (foundation + event-typing sprints)
- **Epic:** None
- **Description:** Type system foundation cleanup + EventExpr CanonicalType + Step type fixes
- **Planning Files:** `.agent_planning/canonical-type/`
- **Summary:** Foundation (C-7, C-3, C-2) and event-typing (C-1, C-6) sprints complete. All EventExpr variants typed, eventType() helper added, 6 Step types now use branded InstanceId. 2033 tests passing.
- **Completed:** 2026-01-28

#### üìã authority-consolidation [PLANNING]
- **State:** PLANNING
- **Epic:** canonical-type Sprint 3
- **Spec:** `design-docs/canonical-types/00-exhaustive-type-system.md`, `15-FiveAxesTypeSystem-Conclusion.md`
- **Description:** Remove dual authority violations (instanceId from FieldExpr nodes) and implement axis enforcement pass as canonical validation gate
- **Planning Files:** `.agent_planning/canonical-type/SPRINT-2026-01-28-192541-authority-consolidation-*.md`
- **Status Note:** P0 (C-5): getManyInstance helper + remove instanceId. P1 (C-4): Axis enforcement pass. Confidence: MEDIUM (C-5 null contract), HIGH (C-4).
- **Key Work Items:**
  - C-5 (P0): Add getManyInstance(type): InstanceRef | null to canonical-types.ts
  - C-5 (P0): Remove instanceId from FieldExprMap/Zip/ZipSig (3 interfaces)
  - C-5 (P0): Update 30+ call sites to derive instance from type
  - C-4 (P1): Create axis-enforcement pass (pure checker, AxisInvalid diagnostic only)
- **Acceptance Criteria:** 50+ axis enforcement tests, all tests pass, TypeScript clean

#### üîÑ type-system [IN PROGRESS]
- **State:** IN PROGRESS (Phase 1 Unified Plan P1)
- **Epic:** Phase 1 Unified Plan (P1)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/01-type-system.md`
- **Description:** AxesDescIR integration, bridge functions, SlotMetaEntry population
- **Planning Files:** `.agent_planning/phase1-remaining/`
- **Status Note:** Remaining work - AxesDescIR and bridge functions

#### üìã time-model [PLANNING]
- **State:** PLANNING
- **Epic:** Phase 1 Unified Plan (P2)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/03-time-system.md`
- **Description:** Dual-phase TimeRoot (phaseA/phaseB independent periods), phase continuity on hot-swap
- **Planning Files:** `.agent_planning/time-model/`
- **Status Note:** Sprint plan APPROVED. P0: Dual-phase TimeRoot, P1: Runtime tracking, P2: Phase continuity

#### üìã buses-and-rails [PLANNING]
- **State:** PLANNING
- **Epic:** Phase 1 Unified Plan (P5)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/02-block-system.md`
- **Description:** Multi-writer combine, default sources, rail system
- **Planning Files:** `.agent_planning/phase1-remaining/`
- **Status Note:** ~10% complete, major work pending

#### ‚úÖ compilation-pipeline [COMPLETED]
- **State:** COMPLETED
- **Epic:** Phase 1 Unified Plan (P3)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md`
- **Description:** Code cleanup after successful implementation of all 8 compilation passes
- **Planning Files:** `.agent_planning/compilation-pipeline/`
- **Beads Issue:** oscilla-animator-v2-k0v (closed)
- **Completed:** 2026-01-19
- **Summary:** All 8 passes implemented and working. Code cleanup completed: removed unused state API stubs, documented Pass 8 decision, resolved seed management TODO. 372 tests passing, 0 failures.
- **Commits:**
  - 3bbc970 - "docs(compiler): Document Pass 8 status and decision"
  - 217be30 - "refactor(compiler): Remove unused state API stubs"
  - b0f8005 - "docs(compiler): Resolve seed management TODO in Pass 6"
- **Key Finding:** "Passes 5-10" was a miscount. There are only 8 passes (1-8), all complete:
  1. ‚úÖ Normalization
  2. ‚úÖ Type Graph
  3. ‚úÖ Time Topology
  4. ‚úÖ Dependency Graph
  5. ‚úÖ SCC Validation
  6. ‚úÖ Block Lowering
  7. ‚úÖ Schedule Construction
  8. ‚úÖ Link Resolution (reference implementation, not used - Pass 6 handles all resolution)
- **Completed Sprints:**
  - Domain Unification - 11 tests passing, domain tracking through field composition
  - Graph Normalization Adapters - Type-aware adapter insertion (signal‚Üífield broadcast), strict type checking in Pass 2, extensible adapter registry
  - Domain‚ÜíInstance Migration - Replaced vestigial DomainId with InstanceId throughout IR. DomainId type removed entirely. inferFieldInstance() replaces inferFieldDomain().
  - Pipeline Cleanup - Removed 4 unused state API stubs, documented Pass 8, resolved seed TODO

#### üìã runtime-execution [PLANNING]
- **State:** PLANNING
- **Epic:** Phase 1 Unified Plan (P4)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/05-runtime.md`
- **Description:** Offset-addressed execution, schedule executor update
- **Planning Files:** `.agent_planning/phase1-remaining/`
- **Status Note:** ~50% complete, offset addressing needed

#### ‚úÖ primitives-catalog [COMPLETED]
- **State:** COMPLETED
- **Epic:** Phase 1 Unified Plan (P6)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/02-block-system.md`
- **Description:** Basic 12 completion, stateful primitives, composites
- **Planning Files:** `.agent_planning/primitives-catalog/`
- **Completed:** 2025-01-21
- **Summary:** All MVP stateful primitives implemented (UnitDelay, Lag, Phasor, SampleAndHold, Accumulator). Hash and Id01 also complete. 547 tests passing.

#### üìã field-blocks-expansion [PLANNING]
- **State:** PLANNING
- **Epic:** Phase 1 Unified Plan (Extended)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/02-block-system.md:195+`
- **Description:** Extended block system: SpiralLayout, RandomScatter, AlongPath, vector state blocks (FieldLag, FieldUnitDelay, FieldPhasor), Polygon primitive, enhanced per-element randomness (AnimatedNoise, NoiseField, GaussianRandom)
- **Planning Files:** `.agent_planning/field-blocks-expansion/`
- **Status Note:** 5-sprint plan ready. Estimated 24-36 hours total.
- **Key Deliverables:**
  - Sprint 1 (P0): SpiralLayout, RandomScatter blocks + kernels
  - Sprint 2 (P1): AnimatedNoise, NoiseField, GaussianRandom blocks
  - Sprint 3 (P2): FieldLag, FieldUnitDelay, FieldPhasor (per-element state)
  - Sprint 4 (P2): Polygon primitive block
  - Sprint 5 (P3): Full AlongPath with arbitrary paths (stretch goal)

#### üìã domain-refactor [PLANNING]
- **State:** PLANNING
- **Epic:** None (Cross-cutting refactor)
- **Spec:** `design-docs/WHAT-IS-A-DOMAIN.md`, `design-docs/WHAT-IS-A-DOMAIN-PART-4-REFACTOR.md`
- **Description:** Complete architectural refactor separating domain TYPE (shape, circle, control) from INSTANTIATION (count, layout). Currently conflated throughout codebase.
- **Planning Files:** `.agent_planning/domain-refactor/`
- **Status Note:** 8-sprint plan ready. Affects ~50 files. Foundation for domain-editor-ui.
- **Key Changes:**
  - Add DomainTypeId, InstanceId, InstanceDecl, LayoutSpec types
  - Create domain registry with hierarchy (circle extends shape)
  - Delete GridDomain/DomainN blocks (embody wrong model)
  - Create new instance blocks (CircleInstance, ShapeInstance)
  - Update all field operations to use instance context
  - Update compiler passes and runtime

#### üìã placement-basis [PLANNING]
- **State:** PLANNING
- **Epic:** Gauge Invariant Continuity
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/11-continuity-system.md` (I2), `topics/17-layout-system.md`
- **Description:** PlacementBasis abstraction for stable per-element placement coordinates (uv, rank, seed) independent of element count N. Eliminates velocity snaps when element count changes.
- **Planning Files:** `.agent_planning/placement-basis/`
- **Status Note:** 7-sprint plan complete (user decisions resolved). Ready for implementation.
- **User Decisions:**
  - Migration: Manual only (no backwards compatibility)
  - BasisKind: User-configurable input parameter
  - Rank: Activation only (not Z-ordering)
  - MaxCount: Pre-allocate to 10k (MAX_ELEMENTS constant)
- **Constraints:**
  - Write NEW layouts (CircleLayoutUV, LineLayoutUV, GridLayoutUV) - no migration of existing
  - Defer compiler validation until new layouts proven gauge-invariant
  - Test as you go, use buffer pools, modular/composable code
  - No arbitrary defaults - hard errors on missing values
- **Key Deliverables:**
  - Sprint 1: Type Foundation + Tests (HIGH)
  - Sprint 2: Generation + Tests (HIGH)
  - Sprint 3: Materialization + Tests (HIGH)
  - Sprint 4: Layout Kernels + Tests (HIGH)
  - Sprint 5: New Layout Blocks + Tests (HIGH)
  - Sprint 6: Persistence & Hot-Swap + Tests (MEDIUM)
  - Sprint 7: Velocity Continuity Integration Tests (HIGH)
  - (Deferred) Compiler Validation
- **Problem Solved:** Current layouts use `normalizedIndex(i, N)` which causes velocity discontinuities when N changes. PlacementBasis provides stable per-element coordinates that persist across count changes.
- **Origin:** `.agent_planning/placement-basis/HANDOFF.md`, ChatGPT conversation on GaugeInvariantLayouts

#### ‚úÖ continuity-crossfade [COMPLETED]
- **State:** COMPLETED
- **Epic:** Continuity System (Part 2)
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/11-continuity-system.md` ¬ß3.7
- **Description:** Implement crossfade policy for continuity system - the fallback when element identity cannot be established
- **Dependencies:** continuity-system (COMPLETED 2026-01-18)
- **Completed:** 2026-01-19
- **Summary:** Sprint 3 Continuity items implemented - crossfade policy with buffer blending, domain change detection and mapping (continuityMapBuild step), gauge/slew application (continuityApply step). 69 continuity tests passing, 358 total tests passing.
- **Key Files Modified:**
  - `src/runtime/ContinuityApply.ts` - Crossfade case implementation with smoothstep/lerp helpers
  - `src/runtime/ContinuityState.ts` - Added crossfadeStartMs and crossfadeOldBuffer to TargetContinuityState
  - `src/runtime/ScheduleExecutor.ts` - Implemented continuityMapBuild and continuityApply step execution
  - `src/runtime/__tests__/ContinuityApply.test.ts` - Unit tests for smoothstep/lerp
  - `src/runtime/__tests__/continuity-integration.test.ts` - Integration tests for crossfade blending
- **Implementation Details:**
  - Buffer crossfade: `X_out[i] = lerp(X_old_eff[i], X_new_base[i], w(t))` where w(t) uses smoothstep curve
  - Old effective values captured BEFORE slew buffer reinitialization to preserve actual previous state
  - Domain change detection creates identity/byId/byPosition mappings based on instance identity mode
  - Crossfade state tracking with start time and old buffer snapshot

---

## üü¢ Phase 2: Rendering & UI [ACTIVE] (5/7 completed)

**Goal:** Implement rendering pipeline and basic UI for patch editing

**Status:** ACTIVE
**Dependencies:** Phase 1 core foundation

### Topics

#### ‚úÖ ui-framework [COMPLETED]
- **State:** COMPLETED
- **Epic:** None
- **Description:** Panel-based UI layout system using jsPanel4 and MUI
- **Completed:** 2026-01-09
- **Summary:** Three-column layout with tabs, toolbar, sidebars. Canvas preview + Patch diagram in center. Inspector, debug, help panels. 146 tests passing. 60 FPS animation.
- **Planning Files:** `.agent_planning/ui-framework/`

#### ‚úÖ diagnostics-system [COMPLETED]
- **State:** COMPLETED (Sprint 1)
- **Epic:** None
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/07-diagnostics-system.md`
- **Description:** Event-driven diagnostics with stable IDs, EventHub coordination, compile/authoring/runtime streams
- **Completed:** 2026-01-11
- **Sprint 1 Summary:** Core infrastructure complete - EventHub, DiagnosticHub, TargetRef (7 kinds), stable diagnostic IDs, authoring validators (<10ms), compiler integration, DiagnosticConsole UI. 206 tests passing. All 15 acceptance criteria met.
- **Planning Files:** `.agent_planning/diagnostics-system/`
- **Sprint 2 Planned:** Runtime diagnostics (NaN/performance monitoring), bus warnings, quick fixes, UI badges
- **Architecture:** Event-driven with five-event contract (GraphCommitted, CompileBegin, CompileEnd, ProgramSwapped, RuntimeHealthSnapshot). Snapshot semantics for compile/authoring (replace), runtime (merge with expiry).

#### ‚úÖ continuity-ui [COMPLETED]
- **State:** COMPLETED
- **Epic:** None
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/11-continuity-system.md`
- **Description:** UI integration for continuity system - live parameter editing, domain change logging, ContinuityPanel
- **Completed:** 2026-01-18
- **Sprint Summary:**
  - **Sprint 1 (Live Param Recompile):** MobX reaction watches block params, debounced recompile (150ms), continuity state preserved across hot-swap. Slider uiHint added to Array block count param.
  - **Sprint 2 (Continuity Logging):** Domain change detection compares old/new instance counts, throttled logging (5/sec per instance), logs to LogPanel.
  - **Sprint 3 (Continuity Panel):** ContinuityStore (MobX), ContinuityPanel component, batched UI updates at 5Hz, domain change history tracking.
- **Planning Files:** `.agent_planning/continuity-ui/`
- **Key Files:**
  - `src/stores/ContinuityStore.ts` - MobX store for continuity state
  - `src/ui/components/app/ContinuityPanel.tsx` - Panel component
  - `src/ui/dockview/panels/ContinuityPanel.tsx` - Dockview wrapper
  - `src/main.ts` - Live recompile and batched updates

#### ‚úÖ ui-features-v2 [COMPLETED]
- **State:** COMPLETED
- **Epic:** None
- **Description:** Visualization and inspection UI - Table View, Block Inspector, Block Library, Domains Panel
- **Completed:** 2026-01-12
- **Sprint 1:** P0-P2, P6 complete (Block model, roles, bus block)
- **Sprint 2:** P3-P8 complete (Connection Matrix, Split Sidebar, TimeRoot Hidden, DefaultSource Display, Type Preview)
- **Summary:** Full read-only visualization. Connection matrix shows block√óblock adjacency. Split sidebar shows Library+Inspector simultaneously. TimeRoot blocks hidden from UI. Default sources displayed in inspector. Type preview when clicking Library items.
- **Planning Files:** `.agent_planning/ui-features-v2/`

#### üí° renderer-implementation [PROPOSED]
- **State:** PROPOSED
- **Epic:** None
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/06-renderer.md`
- **Description:** Renderer contract, Canvas2D implementation, render commands

#### üîÑ patch-editor-ui [IN PROGRESS]
- **State:** IN PROGRESS (Sprint 2B)
- **Epic:** None
- **Description:** Visual patch editor for creating and editing animation programs
- **Sprint 2A:** COMPLETED (2026-01-13) - All blockers fixed, undo/redo (50 steps), keyboard shortcuts (Ctrl+Z/Y), context menu delete, pan/zoom navigation. 275 tests passing.
- **Sprint 2B:** IN PROGRESS (Phase 1/5 complete) - Auto-layout and minimap integrated. Custom node rendering and parameter UI remaining.
- **Planning Files:** `.agent_planning/patch-editor-ui/`
- **Verification:** `/SPRINT2A-VERIFICATION.md`
- **Current Commit:** cfafede - Auto-layout & minimap plugins integrated
- **Sub-tasks:**
  - ‚úÖ auto-arrange-layout (oscilla-animator-v2-8fp) - COMPLETED 2026-01-19

#### ‚úÖ auto-arrange-layout [COMPLETED]
- **State:** COMPLETED
- **Epic:** patch-editor-ui Sprint 2B Phase 1
- **Description:** Complete and verify auto-arrange layout functionality in React Flow editor using ELK algorithm
- **Planning Files:** `.agent_planning/auto-arrange-layout/`
- **Beads Issue:** oscilla-animator-v2-8fp (closed)
- **Completed:** 2026-01-19
- **Summary:** ELK layout algorithm fully integrated with edge case handling (empty graph, single node) and error handling. 9 comprehensive tests ensure no overlaps, correct spacing, and proper zoom-to-fit. All acceptance criteria met.
- **Commit:** 8a7480f - "feat(ui): Add auto-arrange layout with edge case handling and tests"
- **Key Files:**
  - `src/ui/reactFlowEditor/layout.ts` - ELK layout algorithm (100px node spacing, 80px layer spacing)
  - `src/ui/reactFlowEditor/ReactFlowEditor.tsx:166-195, 302-310` - Button, handler, edge cases
  - `src/ui/reactFlowEditor/__tests__/layout.test.ts` - 9 comprehensive tests
- **Test Results:** 367 tests passing (9 new layout tests), no regressions

#### üìã domain-editor-ui [PLANNING]
- **State:** PLANNING
- **Epic:** None
- **Description:** UI for creating and selecting domains - presets vs custom configuration, domain management UX
- **Planning Files:** `.agent_planning/domain-editor-ui/`
- **Recommended Approach:** Parameter Panel + Presets (Option A from research)
- **Dependencies:** patch-editor-ui, Phase 1 complete
- **Origin:** Identified during compilation-pipeline domain unification sprint (2026-01-09)

#### üìã adapter-system-improvement [PLANNING]
- **State:** PLANNING
- **Epic:** `oscilla-animator-v2-o7a`
- **Description:** Per-port-per-connection adapters, resource addressing (`my_block.inputs.count.adapters.<name>`), visual representation on wires, auto-insertion by editor
- **Planning Files:** `.agent_planning/adapter-system-improvement/`
- **Dependencies:** canonical-addressing (COMPLETED)
- **Origin:** User requirement for improved adapter UX and addressing
- **Sprints:**
  - Sprint 1 (P1): Data Model & Addressing - `oscilla-animator-v2-53c`
  - Sprint 2 (P1): Normalization Pass Updates - `oscilla-animator-v2-mtc`
  - Sprint 3 (P1): Editor Integration - `oscilla-animator-v2-lrc`
  - Sprint 4 (P2): UI Visualization - `oscilla-animator-v2-166`
  - Sprint 5 (P2): Context Menu & Editing - `oscilla-animator-v2-u01`

---

## ‚è∏Ô∏è Phase 3: Advanced Features [QUEUED] (0/2 completed)

**Goal:** Implement advanced system features and optimizations

**Status:** QUEUED
**Dependencies:** Phase 2 rendering

### Topics

#### üí° phase-matching-system [PROPOSED]
- **State:** PROPOSED
- **Epic:** None
- **Spec:** `design-docs/spec-archived-20260109-160000/time/10-phase-matching-system.md`
- **Description:** Phase matching and unwrapping system

#### üí° transforms-catalog [PROPOSED]
- **State:** PROPOSED
- **Epic:** None
- **Spec:** `design-docs/spec-archived-20260109-160000/graph/07-transforms.md`
- **Description:** Transform blocks, lens/adapter stacks, full catalog

---

## Legend

**Phase Status:**
- üü¢ ACTIVE - Currently being worked on
- ‚è∏Ô∏è QUEUED - Planned but not started
- ‚úÖ COMPLETED - All topics completed
- üî¥ BLOCKED - Cannot proceed due to dependencies

**Topic Status:**
- üí° PROPOSED - Identified but no planning yet
- üìã PLANNING - Planning files exist, ready for implementation
- üîÑ IN PROGRESS - Implementation started
- ‚úÖ COMPLETED - All acceptance criteria met
- üì¶ ARCHIVED - No longer maintained

**Notes:**
- Topics align with canonical spec in `design-docs/CANONICAL-oscilla-v2.5-20260109/`
- Each topic should have planning files in `.agent_planning/<topic>/`
- Phase 1 remaining work unified in `.agent_planning/phase1-remaining/`
- Use `/do:roadmap <topic>` to add new topics
- Use `/do:plan <topic>` to create planning files for a topic
- Roadmap is automatically updated by workflow skills (see `.claude/rules/roadmap-hooks.md`)
