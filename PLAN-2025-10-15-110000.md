# Dotfiles Project Backlog

**Generated:** 2025-10-15 11:00:00
**Based on:** STATUS-2025-10-15-043506.md
**Specification:** CLAUDE.md (last modified 2025-10-15)
**Repository:** /Users/bmf/Library/Mobile Documents/com~apple~CloudDocs/_mine/icode/dotfiles

---

## Executive Summary

**Current State:** The dotfiles repository has a **working core** (Dotbot symlink management with profile system) but **broken features** documented as functional. The project is 65% complete with significant gaps in the watchers system, documentation accuracy, and testing infrastructure.

**Total Work Items:** 21 (3 P0, 6 P1, 7 P2, 5 P3)

**Estimated Timeline:**
- P0 (Critical): 3-4 days
- P1 (High): 1-2 weeks
- P2 (Medium): 1 week
- P3 (Low): 3-5 days

**Key Focus Areas:**
1. Fix critical bugs that produce wrong output or break documented features
2. Align documentation with reality (remove false claims)
3. Decide fate of watchers system (fix or remove)
4. Establish testing infrastructure to prevent regression

**Critical Blockers:**
- merge-json.sh produces arrays instead of merged objects (data corruption risk)
- Watchers system cannot execute from iCloud Drive (architectural flaw)
- Documentation references non-existent commands and files (user confusion)

---

## P0 (Critical) - Blocking Issues

### P0-1: Fix merge-json.sh Output Format

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** None
**Spec Reference:** WATCHERS.md lines 123-156 • **Status Reference:** STATUS-2025-10-15-043506.md section 2 (Gap 1)

#### Description
The merge-json.sh script produces an array of objects `[{...}, {...}]` instead of a single merged object `{...}`. This is a critical bug that would cause data corruption if the watchers system were used. The jq filter on line 19 is incorrect.

#### Acceptance Criteria
- [ ] Script produces a single merged JSON object, not an array
- [ ] Test with 2 input files: output matches expected merged structure
- [ ] Test with 3+ input files: later files correctly override earlier values
- [ ] Verify deep merge works: nested objects are merged, not replaced
- [ ] Add validation to script: check output is object type, not array
- [ ] Unit test captures this bug and prevents regression

#### Technical Notes
Current line 19: `FILTER="reduce inputs as \$item (.; . * \$item)"`

Fix options:
1. For simple 2-file merge: `jq -s '.[0] * .[1]' file1 file2`
2. For n-file merge: `jq -n 'reduce inputs as $item ({}; . * $item)' file1 file2 file3...`
3. Current filter wraps inputs in array due to missing initial object

The bug exists because the reduce starts with `.` (current input) instead of `{}` (empty object).

---

### P0-2: Document or Fix iCloud Drive Limitation

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** Decision on watchers system architecture
**Spec Reference:** WATCHERS.md (entire document) • **Status Reference:** STATUS-2025-10-15-043506.md section 5 (Risk 1)

#### Description
launchd agents cannot execute scripts stored in iCloud Drive without Full Disk Access permissions. This is a fundamental architectural issue that makes the entire watchers system non-functional when the dotfiles repository is stored at `~/Library/Mobile Documents/com~apple~CloudDocs/_mine/icode/dotfiles`.

#### Acceptance Criteria
- [ ] Decision made: fix architecture OR remove watchers feature
- [ ] If fixing: implement one of the solutions below
- [ ] If removing: complete P1-6 (remove all watchers documentation)
- [ ] WATCHERS.md includes prominent warning about iCloud limitation
- [ ] Test on fresh system: watchers work or are removed

#### Technical Notes
Three architectural solutions:

**Option A: Move repository outside iCloud**
- Pro: Simple, no code changes
- Con: Loses iCloud sync benefits

**Option B: Copy scripts to non-iCloud location during setup**
- Pro: Keeps repo in iCloud
- Con: Scripts and sources are in different locations (maintenance burden)
- Implementation: Modify setup-watchers.sh to copy scripts to ~/bin or ~/.local/bin

**Option C: Use fswatch instead of launchd**
- Pro: No permission issues
- Con: Requires fswatch installation, different architecture
- Implementation: Replace launchd plists with fswatch daemon

**Recommendation:** Option B (copy scripts) if watchers are valuable, otherwise remove the feature entirely.

---

### P0-3: Remove or Create Missing `install` Wrapper Script

**Status:** Not Started
**Effort:** Small (4-6 hours)
**Dependencies:** None
**Spec Reference:** README.md line 130, CLAUDE.md line 34, MIGRATION.md lines 86-96 • **Status Reference:** STATUS-2025-10-15-043506.md section 6 (Gap 2)

#### Description
Documentation extensively references an `./install` wrapper script that does not exist. Multiple documents instruct users to run `./install home` or `./install work`, which will fail with "command not found". This is a documentation integrity issue that undermines user trust.

#### Acceptance Criteria
- [ ] Decision made: create script OR remove all references
- [ ] If creating: script accepts `home` or `work` argument
- [ ] If creating: script wraps Dotbot with correct config composition
- [ ] If removing: all references removed from README.md, CLAUDE.md, MIGRATION.md
- [ ] Documentation internally consistent (no contradictions)
- [ ] Test: follow README installation instructions on fresh system

#### Technical Notes
**If creating the script**, it should:
```bash
#!/usr/bin/env bash
set -euo pipefail

PROFILE="${1:-}"
if [[ -z "$PROFILE" ]]; then
  echo "Usage: ./install [home|work]"
  exit 1
fi

case "$PROFILE" in
  home)
    ./dotbot/bin/dotbot -d . -c install.conf.yaml -c install-home.conf.yaml
    ;;
  work)
    ./dotbot/bin/dotbot -d . -c install.conf.yaml -c install-work.conf.yaml
    ;;
  *)
    echo "Unknown profile: $PROFILE"
    exit 1
    ;;
esac
```

**If removing references:**
- README.md: line 130 (file tree), update installation instructions
- CLAUDE.md: line 34, lines 166-176 (usage examples)
- MIGRATION.md: lines 86-96 (comparison table)

**Recommendation:** Create the script - it adds user convenience and matches documented behavior.

---

## P1 (High) - Important Broken Features

### P1-1: Fix Phantom Justfile Commands in Documentation

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** None
**Spec Reference:** CLAUDE.md lines 166-176, MIGRATION.md lines 150, 276 • **Status Reference:** STATUS-2025-10-15-043506.md section 6 (Gap 3)

#### Description
Documentation references three justfile commands that do not exist: `just add-file-home`, `just test-home`, and `just validate-yaml`. Users attempting to follow documentation will encounter errors.

#### Acceptance Criteria
- [ ] `just add-file-home` either implemented OR all references removed
- [ ] `just test-home` fixed to `just dry-run-home` OR implemented as test command
- [ ] `just validate-yaml` fixed to `just validate` in all locations
- [ ] Grep confirms no references to non-existent commands remain
- [ ] If implementing commands: they work as documented

#### Technical Notes
**Missing commands:**

1. `just add-file-home` (CLAUDE.md line 173)
   - Referenced in "Adding New Dotfiles" workflow
   - Would need to: add entry to install-home.conf.yaml, create file
   - Could be simple helper: `echo "~/.${1}: dotfiles-home/${1}" >> install-home.conf.yaml`

2. `just test-home` (MIGRATION.md line 150)
   - Should be `just dry-run-home` (which exists)
   - Simple find/replace fix

3. `just validate-yaml` (MIGRATION.md line 276)
   - Should be `just validate` (which exists)
   - Simple find/replace fix

**Recommendation:** Fix #2 and #3 to reference existing commands. For #1, either implement the helper (5-10 lines) or document the manual method only.

---

### P1-2: Verify and Test Existing Justfile Commands

**Status:** Not Started
**Effort:** Medium (1 day)
**Dependencies:** None
**Spec Reference:** CLAUDE.md lines 146-153 • **Status Reference:** STATUS-2025-10-15-043506.md section 2 (Justfile Commands table)

#### Description
Several justfile commands are implemented but have never been tested: `verify-home`, `verify-work`, `backup`, and `clean-broken`. These commands are documented as working but may have bugs.

#### Acceptance Criteria
- [ ] Test `just verify-home` on home profile: correctly validates symlinks
- [ ] Test `just verify-work` on work profile: correctly validates symlinks
- [ ] Test `just backup`: creates backup, files are restorable
- [ ] Test `just clean-broken`: removes only broken symlinks, preserves valid ones
- [ ] Document test results and any bugs found
- [ ] Fix any bugs discovered during testing
- [ ] Add to README if commands work as expected

#### Technical Notes
Commands to test (from justfile lines 80-340):
- `verify-home` and `verify-work`: Check symlinks point to correct profile
- `backup`: Should create timestamped backup of current dotfiles
- `clean-broken`: Should find and remove broken symlinks in ~/

Testing approach:
1. Create test environment (separate directory or VM)
2. Install home profile
3. Run verify-home (should pass)
4. Run verify-work (should fail or warn)
5. Modify symlinks to break them
6. Run clean-broken (should remove only broken ones)
7. Run backup (should create .backup directory)

---

### P1-3: Update WATCHERS.md Examples with Real Output

**Status:** Not Started
**Effort:** Medium (4-6 hours)
**Dependencies:** P0-1 (merge-json.sh fix)
**Spec Reference:** WATCHERS.md lines 123-156 • **Status Reference:** STATUS-2025-10-15-043506.md section 6 (Gap 4)

#### Description
WATCHERS.md shows example merged JSON output that does not match the actual script behavior. The examples were never tested. After fixing merge-json.sh, the documentation needs to be updated with real, tested examples.

#### Acceptance Criteria
- [ ] Execute all examples in WATCHERS.md sections 3.1-3.3
- [ ] Capture actual output from merge-json.sh
- [ ] Update documentation with real output (replace lines 147-155)
- [ ] Verify "Testing Your Setup" section (lines 106-122) with real tests
- [ ] Add "Tested on: <date>" note to examples
- [ ] Confirm deep merge examples work correctly

#### Technical Notes
Testing sequence (from WATCHERS.md):
1. Create config-sources/base-config.json
2. Create config-sources/home-override.json
3. Run merge-json.sh
4. Capture output in ~/.config/app-config.json
5. Verify structure matches specification
6. Document actual behavior vs. documented behavior

Must test:
- Simple key override (editor: vim → idea)
- Nested object merge (settings object)
- Array handling (if any)
- Multiple file merge (3+ inputs)

---

### P1-4: Clarify install_dotfiles.sh Status

**Status:** Not Started
**Effort:** Small (1-2 hours)
**Dependencies:** None
**Spec Reference:** CLAUDE.md line 35 • **Status Reference:** STATUS-2025-10-15-043506.md section 5 (Risk 5)

#### Description
CLAUDE.md line 35 states `install_dotfiles.sh` is "removed" but the file exists and is functional. This creates confusion about which installation method to use.

#### Acceptance Criteria
- [ ] Decision made: remove script OR keep as deprecated
- [ ] If removing: delete file, update git history note in README
- [ ] If keeping: update CLAUDE.md to say "deprecated but available for legacy use"
- [ ] README.md clearly states primary installation method (justfile)
- [ ] No contradiction between "removed" and file existence

#### Technical Notes
Current state:
- File exists: `install_dotfiles.sh` (functional, 200+ lines)
- CLAUDE.md says: "removed"
- MIGRATION.md says: "old custom script - see MIGRATION.md"

Options:
1. **Remove entirely**: Delete file, note removal in README
2. **Keep as deprecated**: Update docs to say "available for legacy users"
3. **Archive**: Move to `archive/` directory

**Recommendation:** Keep in `archive/` directory with note explaining it's superseded by justfile but preserved for reference.

---

### P1-5: Fix README.md Factual Inaccuracies

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** None
**Spec Reference:** README.md lines 44, 101, 130 • **Status Reference:** STATUS-2025-10-15-043506.md section 7 (Misleading Documentation)

#### Description
README.md contains multiple factual errors: claims Volta is used (it's commented out), references non-existent `add-file-home` command, and lists non-existent `install` script in file tree.

#### Acceptance Criteria
- [ ] Line 44: Change "Volta" to "fnm (preferred) with NVM fallback"
- [ ] Line 101: Remove `just add-file-home` OR implement the command
- [ ] Line 130: Update file tree to match actual repository structure
- [ ] Verify no other factual errors in README
- [ ] README accurately reflects current implementation

#### Technical Notes
Specific fixes:

**Line 44:** Change from:
```
- Node.js with Volta for version management
```
To:
```
- Node.js with fnm (preferred), NVM, and bun for version management
```

**Line 101:** Either remove example or add command to justfile

**Line 130:** Update file tree:
- Remove `install` or mark as [to be created]
- Ensure all listed files actually exist
- Add any significant new files (WATCHERS.md, STATUS-*.md, etc.)

---

### P1-6: Remove or Fix Watchers System

**Status:** Not Started
**Effort:** Large (1-2 weeks)
**Dependencies:** P0-1 (merge-json.sh fix), P0-2 (architecture decision)
**Spec Reference:** WATCHERS.md (entire document) • **Status Reference:** STATUS-2025-10-15-043506.md section 6 (Gap 1)

#### Description
The watchers system is documented as functional but is completely broken. Must either fix the entire system and test it end-to-end, or remove it from documentation and codebase.

#### Acceptance Criteria

**If fixing:**
- [ ] Implement solution to iCloud Drive permission issue (P0-2)
- [ ] Fix merge-json.sh output format (P0-1)
- [ ] Test watcher creation: `just setup-watchers` succeeds
- [ ] Test watcher execution: modifying source triggers merge
- [ ] Test output validation: merged JSON is correct format
- [ ] Test example watcher: setup-example-watcher.sh works end-to-end
- [ ] Document limitations and requirements in WATCHERS.md
- [ ] Add troubleshooting section for common issues

**If removing:**
- [ ] Delete WATCHERS.md
- [ ] Delete scripts/merge-json.sh
- [ ] Delete scripts/setup-watchers.sh
- [ ] Delete scripts/setup-example-watcher.sh
- [ ] Delete install-watchers.conf.yaml
- [ ] Remove all references from README.md
- [ ] Remove all references from CLAUDE.md
- [ ] Remove watchers commands from justfile (setup-watchers, list-watchers)
- [ ] Archive deleted files in git history with explanation

#### Technical Notes
**Recommendation:** Remove the feature unless there's strong need for it.

Reasons to remove:
- Fundamental architecture incompatibility with iCloud Drive
- No evidence of actual usage (no active watchers found)
- Significant complexity for limited benefit
- Can be reimplemented later if needed

Reasons to fix:
- Demonstrates advanced shell scripting capabilities
- Could be useful for complex multi-source configs
- Documentation effort already invested

If fixing, see P0-2 for architecture options.

---

## P2 (Medium) - Quality Improvements

### P2-1: Create Basic Test Suite for Core Functionality

**Status:** Not Started
**Effort:** Large (1 week)
**Dependencies:** None
**Spec Reference:** Global CLAUDE.md (testing standards) • **Status Reference:** STATUS-2025-10-15-043506.md section 6 (Gap 5)

#### Description
The repository has zero automated tests. The merge-json.sh bug and untested watchers system demonstrate that manual testing is insufficient. Need basic test coverage for core functionality.

#### Acceptance Criteria
- [ ] Test framework chosen and configured (bats, shunit2, or simple bash)
- [ ] Tests for symlink creation (install-home, install-work)
- [ ] Tests for profile switching (global → home → work)
- [ ] Tests for merge-json.sh output format (would have caught current bug)
- [ ] Tests for justfile commands (dry-run, status, validate)
- [ ] Tests can run in CI environment (no modification of actual ~/)
- [ ] Test runner script: `just test` or `./run-tests.sh`
- [ ] Tests pass on fresh system
- [ ] README documents how to run tests

#### Technical Notes
Testing approach:

**Framework options:**
1. **bats** (Bash Automated Testing System): Industry standard, good documentation
2. **shunit2**: Lightweight, xUnit-style
3. **Custom bash scripts**: Simple, no dependencies

**Test structure:**
```
tests/
  ├── test-symlinks.sh         # Test dotbot symlink creation
  ├── test-profile-switching.sh # Test profile composition
  ├── test-merge-json.sh        # Test JSON merging (CRITICAL)
  ├── test-justfile.sh          # Test justfile commands
  └── fixtures/                 # Test data
      ├── test-home.conf.yaml
      └── test-configs/
```

**Testing symlinks without modifying ~/**:
- Use `DOTBOT_DIR` and `HOME` environment variables
- Create temporary test directory
- Run dotbot with test configs pointing to temp home

Example:
```bash
test_home_profile_creates_zshrc() {
  TEMP_HOME=$(mktemp -d)
  HOME=$TEMP_HOME ./dotbot/bin/dotbot -c test-home.conf.yaml
  assert_link_exists "$TEMP_HOME/.zshrc"
  assert_link_target "$TEMP_HOME/.zshrc" "dotfiles-home/zshrc"
}
```

**Priority tests:**
1. merge-json.sh output is object, not array (catches current bug)
2. Profile switching correctly overrides global configs
3. Symlinks point to expected files
4. YAML configs are valid

---

### P2-2: Add Validation to merge-json.sh

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** P0-1 (merge-json.sh fix)
**Spec Reference:** WATCHERS.md • **Status Reference:** STATUS-2025-10-15-043506.md section 3 (Error Handling)

#### Description
The merge-json.sh script lacks output validation. After fixing the merge logic, add checks to ensure the output is a valid JSON object (not array) and that the merge succeeded.

#### Acceptance Criteria
- [ ] Check jq exit code: fail if jq command fails
- [ ] Validate output is JSON object type (not array, null, string)
- [ ] Validate output has expected keys (if base config defines schema)
- [ ] Output error message if validation fails
- [ ] Return non-zero exit code on validation failure
- [ ] Test with malformed input: script detects and reports error

#### Technical Notes
Add validation after jq merge (after line 19):

```bash
# Validate output is object
if ! jq -e 'type == "object"' "$OUTPUT_FILE" > /dev/null; then
  echo "ERROR: Merged output is not a JSON object" >&2
  jq 'type' "$OUTPUT_FILE" >&2
  exit 1
fi

# Validate output has content
if ! jq -e 'length > 0' "$OUTPUT_FILE" > /dev/null; then
  echo "ERROR: Merged output is empty" >&2
  exit 1
fi

echo "✓ Validation passed: output is valid JSON object"
```

Optional: Schema validation
- If base config includes `"$schema": "..."`, validate against it
- Use jq to check required keys are present
- Useful for complex configs

---

### P2-3: Add Troubleshooting Section to Documentation

**Status:** Not Started
**Effort:** Medium (4-6 hours)
**Dependencies:** P1-2 (test justfile commands)
**Spec Reference:** CLAUDE.md, README.md • **Status Reference:** STATUS-2025-10-15-043506.md section 3 (Documentation Completeness)

#### Description
Documentation lacks troubleshooting guidance. Users encountering issues (iCloud permissions, broken symlinks, jq missing) have no guidance for resolution.

#### Acceptance Criteria
- [ ] TROUBLESHOOTING.md created with common issues
- [ ] How to detect if watchers are failing (if feature kept)
- [ ] How to verify symlinks are correct (`just verify-home`)
- [ ] How to fix broken symlinks (`just clean-broken`)
- [ ] What to do if jq is missing
- [ ] How to check if profile is correctly installed
- [ ] macOS-specific issues (iCloud, launchd permissions)
- [ ] Linked from README.md

#### Technical Notes
Common issues to document:

**1. iCloud Drive Permission Errors**
- Symptom: launchd watchers fail with "Operation not permitted"
- Cause: launchd cannot access iCloud Drive
- Solution: Move repo outside iCloud OR use alternative watching method

**2. Broken Symlinks**
- Symptom: `ls -la ~/.zshrc` shows broken link
- Cause: Dotfiles moved or deleted
- Solution: `just install-home` to recreate symlinks

**3. Missing jq**
- Symptom: merge-json.sh fails with "jq: command not found"
- Cause: jq not installed
- Solution: `brew install jq`

**4. Wrong Profile Active**
- Symptom: Work zshrc loaded instead of home
- Cause: Wrong symlinks installed
- Solution: `just install-home` to switch profile

**5. Dotbot Submodule Not Initialized**
- Symptom: `./dotbot/bin/dotbot: No such file or directory`
- Cause: Git submodule not cloned
- Solution: `git submodule update --init --recursive`

---

### P2-4: Document Actual Behavior vs. Specification

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** All P1 items (documentation fixes)
**Spec Reference:** All documentation files • **Status Reference:** STATUS-2025-10-15-043506.md section 2 (Documentation Accuracy)

#### Description
After fixing documentation inaccuracies, create a summary document that tracks where actual implementation differs from original specifications and why.

#### Acceptance Criteria
- [ ] Document created: IMPLEMENTATION-NOTES.md or added to CLAUDE.md
- [ ] Lists all known deviations from spec (e.g., Volta → fnm)
- [ ] Explains why each deviation occurred
- [ ] Notes any features removed (e.g., watchers if removed)
- [ ] Serves as reference for future development
- [ ] Kept in sync with codebase

#### Technical Notes
Sections to include:

**1. Architecture Decisions**
- Why justfile is primary interface (not install script)
- Why fnm instead of Volta for Node.js
- If watchers removed: why they were removed

**2. Feature Status**
- Implemented and working
- Implemented but untested
- Documented but not implemented
- Removed or deprecated

**3. Known Limitations**
- iCloud Drive incompatibility with launchd (if watchers kept)
- Platform-specific behaviors (macOS-only features)
- Dependencies on external tools (jq, lsd, etc.)

**4. Future Enhancements**
- Features planned but not yet implemented
- Improvements to existing features
- Technical debt to address

---

### P2-5: Standardize Error Handling Across Scripts

**Status:** Not Started
**Effort:** Medium (1 day)
**Dependencies:** None
**Spec Reference:** Global CLAUDE.md (best practices) • **Status Reference:** STATUS-2025-10-15-043506.md section 3 (Error Handling)

#### Description
Shell scripts use `set -euo pipefail` but lack consistent error handling patterns. Standardize error reporting, exit codes, and user-facing error messages.

#### Acceptance Criteria
- [ ] All scripts use `set -euo pipefail`
- [ ] Error messages go to stderr (`>&2`)
- [ ] Exit codes follow convention (0=success, 1=error, 2=usage)
- [ ] User-facing errors are clear and actionable
- [ ] Common error handling functions extracted to shared library
- [ ] Scripts check for required dependencies (jq, dotbot, etc.)
- [ ] Test error conditions: scripts fail gracefully

#### Technical Notes
Create shared error handling library: `scripts/lib/errors.sh`

```bash
# scripts/lib/errors.sh
error() {
  echo "ERROR: $*" >&2
}

fatal() {
  error "$@"
  exit 1
}

require_command() {
  if ! command -v "$1" &> /dev/null; then
    fatal "$1 is required but not installed. Install with: $2"
  fi
}

# Usage in scripts:
source "$(dirname "$0")/lib/errors.sh"
require_command jq "brew install jq"
```

Standardize exit codes:
- 0: Success
- 1: General error
- 2: Usage error (wrong arguments)
- 126: Command cannot execute (permissions)
- 127: Command not found

---

### P2-6: Add Pre-commit Hooks for Quality Checks

**Status:** Not Started
**Effort:** Medium (1 day)
**Dependencies:** P2-1 (test suite)
**Spec Reference:** Global CLAUDE.md (dev workflow) • **Status Reference:** STATUS-2025-10-15-043506.md section 3 (Test Coverage)

#### Description
Prevent bugs from being committed by adding pre-commit hooks that validate YAML, run tests, and check shell scripts.

#### Acceptance Criteria
- [ ] .pre-commit-config.yaml created
- [ ] Hook: Validate YAML syntax for all .yaml files
- [ ] Hook: Run shellcheck on all .sh scripts
- [ ] Hook: Run test suite (if tests are fast enough)
- [ ] Hook: Check for merge-json.sh regression (output is object)
- [ ] Hooks can be bypassed with `--no-verify` if needed
- [ ] README documents pre-commit setup
- [ ] CI runs same checks

#### Technical Notes
Use pre-commit framework: https://pre-commit.com/

Example `.pre-commit-config.yaml`:
```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: check-yaml
      - id: check-executables-have-shebangs
      - id: check-shebang-scripts-are-executable

  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.2
    hooks:
      - id: shellcheck
        args: [--severity=warning]

  - repo: local
    hooks:
      - id: test-merge-json
        name: Test merge-json.sh
        entry: tests/test-merge-json.sh
        language: script
        pass_filenames: false
```

Install: `brew install pre-commit && pre-commit install`

---

### P2-7: Add GitHub Actions CI Pipeline

**Status:** Not Started
**Effort:** Medium (1 day)
**Dependencies:** P2-1 (test suite), P2-6 (pre-commit hooks)
**Spec Reference:** Global CLAUDE.md (testing standards) • **Status Reference:** STATUS-2025-10-15-043506.md section 3 (Test Coverage)

#### Description
Automate quality checks in CI to catch issues before they reach main branch. Run tests, validate YAML, lint shell scripts.

#### Acceptance Criteria
- [ ] .github/workflows/ci.yml created
- [ ] CI runs on push to main and pull requests
- [ ] Validates all YAML configs with yamllint
- [ ] Lints all shell scripts with shellcheck
- [ ] Runs test suite (from P2-1)
- [ ] Tests merge-json.sh specifically (critical bug prevention)
- [ ] CI badge in README.md
- [ ] Fast feedback (<5 min run time)

#### Technical Notes
Example `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install jq shellcheck yamllint

      - name: Validate YAML
        run: |
          yamllint *.yaml

      - name: Lint shell scripts
        run: |
          shellcheck scripts/*.sh

      - name: Run tests
        run: |
          ./run-tests.sh

      - name: Test merge-json.sh critical bug
        run: |
          # Ensure output is object, not array
          OUTPUT=$(./scripts/merge-json.sh /tmp/out.json tests/fixtures/base.json tests/fixtures/override.json)
          if ! jq -e 'type == "object"' /tmp/out.json; then
            echo "FAIL: merge-json.sh produced non-object output"
            exit 1
          fi
```

---

## P3 (Low) - Nice-to-Have Enhancements

### P3-1: Implement `just add-file-home` Helper Command

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** P1-1 (documentation fix)
**Spec Reference:** CLAUDE.md lines 166-176 • **Status Reference:** STATUS-2025-10-15-043506.md section 6 (Gap 3)

#### Description
Currently documented but not implemented, this command would simplify adding new dotfiles by automating the YAML config update.

#### Acceptance Criteria
- [ ] `just add-file-home <filename>` adds entry to install-home.conf.yaml
- [ ] `just add-file-work <filename>` adds entry to install-work.conf.yaml
- [ ] Command validates file exists in dotfiles-home/ or dotfiles-work/
- [ ] Command prevents duplicate entries
- [ ] Updates documentation with correct usage
- [ ] Test: can add new file and install successfully

#### Technical Notes
Add to justfile:

```makefile
# Add a file to home profile configuration
add-file-home FILE:
    #!/usr/bin/env bash
    set -euo pipefail
    if [[ ! -f "dotfiles-home/{{FILE}}" ]]; then
      echo "Error: dotfiles-home/{{FILE}} does not exist" >&2
      exit 1
    fi
    if grep -q "~/\.{{FILE}}" install-home.conf.yaml; then
      echo "Warning: {{FILE}} already in install-home.conf.yaml"
      exit 0
    fi
    echo "  ~/.{{FILE}}: dotfiles-home/{{FILE}}" >> install-home.conf.yaml
    echo "✓ Added {{FILE}} to install-home.conf.yaml"
```

Similar implementation for `add-file-work`.

---

### P3-2: Create Installation Demo/Tutorial

**Status:** Not Started
**Effort:** Medium (1 day)
**Dependencies:** P0-3 (install script), P1-5 (README fixes)
**Spec Reference:** README.md, CLAUDE.md • **Status Reference:** None (enhancement)

#### Description
Create screencast or step-by-step tutorial showing fresh installation on new system. Helps users understand the process and builds confidence.

#### Acceptance Criteria
- [ ] Video or animated GIF showing installation
- [ ] Step-by-step written tutorial in README or separate file
- [ ] Covers: clone, submodule init, install home profile
- [ ] Shows profile switching (home → work)
- [ ] Demonstrates verification commands
- [ ] Tutorial tested on fresh macOS system
- [ ] Linked prominently in README

#### Technical Notes
Tools for demo:
- **asciinema**: Record terminal sessions (lightweight, text-based)
- **ScreenFlow**: Professional screencasts (macOS)
- **Markdown**: Step-by-step with screenshots

Tutorial outline:
1. Prerequisites (Git, Homebrew)
2. Clone repository
3. Initialize submodules
4. Install home profile (`just install-home`)
5. Verify installation (`just status`)
6. Test shell (open new terminal, check zsh config)
7. Switch to work profile (`just install-work`)
8. Add new dotfile example

---

### P3-3: Add Backup/Restore Functionality Test

**Status:** Not Started
**Effort:** Small (4 hours)
**Dependencies:** P1-2 (test justfile commands)
**Spec Reference:** CLAUDE.md line 150 • **Status Reference:** STATUS-2025-10-15-043506.md section 2 (Justfile Commands)

#### Description
The `just backup` command exists but has never been tested. Verify it creates usable backups and add restore capability.

#### Acceptance Criteria
- [ ] Test `just backup`: creates timestamped backup directory
- [ ] Verify backup contains copies (not symlinks) of dotfiles
- [ ] Implement `just restore <timestamp>`: restores from backup
- [ ] Test restore: files are correctly restored to ~/
- [ ] Document backup/restore process in README
- [ ] Add to troubleshooting guide

#### Technical Notes
Current backup implementation (if it exists): check justfile

Expected behavior:
- `just backup`: copies ~/.<dotfile> to backups/<timestamp>/
- Creates manifest of what was backed up
- Excludes symlinks or resolves them to actual content

Restore implementation:
```makefile
restore TIMESTAMP:
    #!/usr/bin/env bash
    BACKUP_DIR="backups/{{TIMESTAMP}}"
    if [[ ! -d "$BACKUP_DIR" ]]; then
      echo "Error: Backup $BACKUP_DIR not found" >&2
      exit 1
    fi
    echo "Restoring from $BACKUP_DIR..."
    cp -r "$BACKUP_DIR"/* ~/
    echo "✓ Restored from {{TIMESTAMP}}"
```

---

### P3-4: Enhance Status Command with More Details

**Status:** Not Started
**Effort:** Small (3-4 hours)
**Dependencies:** None
**Spec Reference:** CLAUDE.md line 148 • **Status Reference:** STATUS-2025-10-15-043506.md section 2

#### Description
The `just status` command shows basic profile info. Enhance it to show more useful information: which files are symlinked, any broken links, available profiles, etc.

#### Acceptance Criteria
- [ ] Shows current active profile (home/work/global)
- [ ] Lists all symlinked files with their targets
- [ ] Highlights any broken symlinks
- [ ] Shows last installation time
- [ ] Indicates if any watchers are active (if feature kept)
- [ ] Uses colors for better readability
- [ ] Fast execution (<1 second)

#### Technical Notes
Enhanced output example:
```
Dotfiles Status
═══════════════════════════════════════════════════════

Active Profile: HOME
Installed: 2025-10-14 15:32:10
Repository: ~/icode/dotfiles

Symlinks (12):
  ✓ ~/.zshrc → dotfiles-home/zshrc
  ✓ ~/.rad-plugins → dotfiles-home/rad-plugins
  ✓ ~/.mackup.cfg → dotfiles-home/mackup.cfg
  ✓ ~/.gitignore_global → dotfiles_global/gitignore_global
  ✗ ~/.oldconfig → [BROKEN]

Watchers: 0 active

Profiles Available:
  • home (current)
  • work
  • global
```

Implementation:
- Read all symlinks in ~/
- Check if they point to dotfiles repo
- Use `readlink` to get targets
- Colorize with ANSI codes

---

### P3-5: Document Profile Customization Patterns

**Status:** Not Started
**Effort:** Small (3-4 hours)
**Dependencies:** None
**Spec Reference:** CLAUDE.md (Profile System section) • **Status Reference:** None (enhancement)

#### Description
Document common patterns for customizing profiles: when to override vs. extend, how to share configs between profiles, etc.

#### Acceptance Criteria
- [ ] Document created: PROFILES.md or added to CLAUDE.md
- [ ] Explains when to use global vs. profile-specific configs
- [ ] Shows how to override vs. extend base configs
- [ ] Provides examples of common customization patterns
- [ ] Documents profile-specific environment variables
- [ ] Explains rad-plugins customization
- [ ] Linked from README

#### Technical Notes
Topics to cover:

**1. When to Put Config in Global vs. Profile**
- Global: configs that work everywhere (git ignore, aider)
- Profile: machine-specific (PROJECTS_DIR, work credentials)

**2. Extending vs. Overriding**
- Override: Replace entire file (zshrc, rad-plugins)
- Extend: Source global then add profile-specific (could use in future)

**3. Common Patterns**
```
# Pattern 1: Environment-specific paths
Global: ~/.tool-config (base settings)
Home: ~/.tool-config-home (personal API keys)
Work: ~/.tool-config-work (company credentials)

# Pattern 2: Shared with profile additions
Global: Base .rad-plugins (common tools)
Home: Extended .rad-plugins (home-only plugins)
Work: Extended .rad-plugins (work-only plugins)
```

**4. Profile Detection**
- How to detect which profile is active (check symlink target)
- How to have profile-aware scripts

---

## Dependency Graph

```
P0-1 (Fix merge-json.sh)
  └─> P1-3 (Update WATCHERS.md examples)
  └─> P2-2 (Add validation)
  └─> P1-6 (Fix/remove watchers)

P0-2 (Document iCloud limitation)
  └─> P1-6 (Fix/remove watchers)

P0-3 (Create install script)
  └─> P3-2 (Installation demo)

P1-1 (Fix phantom commands)
  └─> P3-1 (Implement add-file-home)

P1-2 (Test justfile commands)
  └─> P2-3 (Troubleshooting docs)
  └─> P3-3 (Backup/restore test)

P1-5 (Fix README)
  └─> P3-2 (Installation demo)

P2-1 (Test suite)
  └─> P2-6 (Pre-commit hooks)
  └─> P2-7 (CI pipeline)

P2-6 (Pre-commit hooks)
  └─> P2-7 (CI pipeline)
```

**Critical Path:** P0-1 → P0-2 → P1-6 (decide fate of watchers)

**Independent Work:** P0-3, P1-1, P1-2, P1-4, P1-5 can be done in parallel

---

## Recommended Sprint Planning

### Sprint 1: Fix Critical Bugs (Week 1)
**Goal:** Fix data corruption risk and make documentation honest

- P0-1: Fix merge-json.sh (2-3 hours)
- P0-3: Create or remove install script (4-6 hours)
- P1-1: Fix phantom commands (2-3 hours)
- P1-5: Fix README inaccuracies (2-3 hours)
- P1-4: Clarify install_dotfiles.sh status (1-2 hours)

**Estimated effort:** 2-3 days
**Outcome:** No data corruption risk, documentation matches reality

### Sprint 2: Watchers Decision (Week 2)
**Goal:** Decide fate of watchers system and execute decision

- P0-2: Document iCloud limitation (1-2 days)
- P1-6: Fix or remove watchers (1-2 weeks)
- P1-3: Update WATCHERS.md examples (IF keeping) (4-6 hours)
- P2-2: Add merge validation (IF keeping) (2-3 hours)

**Estimated effort:** 3-5 days (if removing), 1-2 weeks (if fixing)
**Outcome:** Watchers either work completely or are removed

### Sprint 3: Testing Infrastructure (Week 3-4)
**Goal:** Establish testing to prevent future bugs

- P1-2: Test justfile commands (1 day)
- P2-1: Create test suite (1 week)
- P2-6: Add pre-commit hooks (1 day)
- P2-7: Add CI pipeline (1 day)

**Estimated effort:** 1.5-2 weeks
**Outcome:** Automated testing prevents regressions

### Sprint 4: Documentation & Quality (Week 5)
**Goal:** Polish documentation and improve error handling

- P2-3: Add troubleshooting section (4-6 hours)
- P2-4: Document deviations from spec (2-3 hours)
- P2-5: Standardize error handling (1 day)
- P3-5: Document profile patterns (3-4 hours)

**Estimated effort:** 3-4 days
**Outcome:** Users can troubleshoot issues, consistent quality

### Sprint 5: Enhancements (Optional)
**Goal:** Nice-to-have improvements

- P3-1: Implement add-file-home (2-3 hours)
- P3-2: Installation demo (1 day)
- P3-3: Backup/restore test (4 hours)
- P3-4: Enhanced status command (3-4 hours)

**Estimated effort:** 2-3 days
**Outcome:** Better user experience

---

## Risk Assessment

### High-Risk Items

**P1-6: Remove or Fix Watchers System**
- **Risk:** Large effort if fixing, user disappointment if removing
- **Uncertainty:** Architecture solution for iCloud compatibility
- **Mitigation:** Make decision early, document reasoning thoroughly

**P2-1: Create Test Suite**
- **Risk:** Time-consuming, may reveal more bugs
- **Uncertainty:** Best framework choice, test environment setup
- **Mitigation:** Start simple (bash scripts), expand as needed

**P0-2: Document iCloud Limitation**
- **Risk:** Fundamental architecture flaw may be unfixable
- **Uncertainty:** Whether any solution is practical
- **Mitigation:** Research alternatives before committing to solution

### Medium-Risk Items

**P2-7: GitHub Actions CI**
- **Risk:** May need macOS runner (expensive) for platform-specific tests
- **Uncertainty:** How to test symlinks in CI environment
- **Mitigation:** Use Ubuntu runner for most tests, document macOS-specific behavior

**P3-2: Installation Demo**
- **Risk:** Video quickly becomes outdated
- **Uncertainty:** Best format for demo (video vs. text)
- **Mitigation:** Use asciinema (text-based, easily updatable)

### Low-Risk Items

Most P1 documentation fixes and P3 enhancements are low-risk:
- Well-defined scope
- No architectural changes
- Easily reversible if needed

---

## Success Metrics

### Completion Criteria

**For P0 (Critical):**
- [ ] merge-json.sh produces correct output format (verified by test)
- [ ] No documentation references non-existent files or commands
- [ ] Users can follow README instructions without errors

**For P1 (High):**
- [ ] All documented justfile commands exist and work
- [ ] Watchers either work end-to-end OR are completely removed
- [ ] No factual errors in documentation

**For P2 (Medium):**
- [ ] At least 50% test coverage of core functionality
- [ ] CI pipeline catches regressions automatically
- [ ] Users have troubleshooting guide for common issues

**For P3 (Low):**
- [ ] Enhanced developer experience (add-file helper, better status)
- [ ] Clear onboarding for new users

### Quality Gates

**Before Merging Any Work:**
- [ ] Tests pass (once test suite exists)
- [ ] Documentation updated to match changes
- [ ] No new bugs introduced (regression check)

**Before Closing Project:**
- [ ] All P0 items complete
- [ ] At least 80% of P1 items complete
- [ ] Test coverage exists for critical functionality
- [ ] Documentation is accurate and complete

---

## Open Questions

1. **Watchers System:** Fix or remove? Need user input on whether this feature is actually needed.

2. **Installation Script:** Create `./install` wrapper or rely solely on justfile? Consider user preference.

3. **Test Framework:** bats vs. shunit2 vs. custom bash? Need to evaluate based on complexity needs.

4. **Repository Location:** Stay in iCloud Drive or move out? Affects watchers solution.

5. **Legacy Script:** Delete install_dotfiles.sh or archive it? Check if any users depend on it.

6. **Backup Strategy:** Is current backup implementation sufficient? May need more robust solution.

---

## Notes

- This backlog is based on STATUS-2025-10-15-043506.md which provides evidence-based assessment
- All gaps and bugs are traceable to specific file paths and line numbers in the STATUS report
- Priority levels reflect impact on users and risk of data corruption
- Estimated efforts are rough approximations; actual time may vary
- Some items may reveal additional work during implementation
- This is a living document; update as work progresses and new issues are discovered

---

**Last Updated:** 2025-10-15 11:00:00
**Next Review:** After Sprint 1 completion (reassess watchers decision)
